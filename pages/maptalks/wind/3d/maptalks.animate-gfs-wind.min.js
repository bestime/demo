(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):(t="undefined"!=typeof globalThis?globalThis:t||self,e(t.maptalksGfsWind={},t.maptalks))})(this,function(t,e){"use strict";function i(t){if(null===t)return void 0===t?"[object Undefined]":"[object Null]";if(!(tt&&tt in Object(t)))return toString.call(t);const e=$.call(t,tt),i=t[tt];let r=!1;try{t[tt]=void 0,r=!0}catch(t){}const n=Object.prototype.toString.call(t);return r&&(e?t[tt]=i:delete t[tt]),n}function r(t){if(!n(t))return!1;const e=i(t);return"[object Function]"===e||"[object AsyncFunction]"===e||"[object GeneratorFunction]"===e||"[object Proxy]"===e}function n(t){const e=typeof t;return null!==t&&("object"===e||"function"===e)}function s(t){return null!=t&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function o(t){return"[object Number]"===Object.prototype.toString.call(t)&&!isNaN(t)}function a(t){return Array.isArray(t)}function l(t,...e){return Object.assign(t,...e)}function c(t,e){console.warn(`${e||"wind-layer"}: ${t}`)}function h(t,e){et[e]||(c(e,t),et[e]=!0)}function g(t,e){return t-e*Math.floor(t/e)}function u(t){return null!=t&&!isNaN(t)}function d(t,e={}){let i=void 0,r=void 0;if(t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":i=t;break;case"1,3":case"2,3":r=t}}),!r||!i)return;const n=i.header,s=new rt({xmin:n.lo1,ymin:n.la1,xmax:n.lo2,ymax:n.la2,deltaX:n.dx,deltaY:n.dy,cols:n.nx,rows:n.ny,us:i.data,vs:r.data,...e});return s}function p(t,e,i,r){return Math.max(0,Math.min(r.length-1,Math.round((t-e)/(i-e)*(r.length-1))))}function m(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}function I(t,e,i){var r=void 0===e?null:e,n=void 0!==i&&i,s=m(t,n),o=s.indexOf("\n",10)+1,a=s.substring(o)+(r?"//# sourceMappingURL="+r:"");return function(t){return new ot(a,Object.assign({},t,{eval:!0}))}}function B(t,e){var i=atob(t);if(e){for(var r=new Uint8Array(i.length),n=0,s=i.length;n<s;++n)r[n]=i.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(r.buffer))}return i}function x(t,e,i){var r=void 0===e?null:e,n=void 0!==i&&i,s=B(t,n),o=s.indexOf("\n",10)+1,a=s.substring(o)+(r?"//# sourceMappingURL="+r:""),l=new Blob([a],{type:"application/javascript"});return URL.createObjectURL(l)}function f(t,e,i){var r;return function(n){return r=r||x(t,e,i),new Worker(r,n)}}function F(){return lt}function v(t,e,i){return F()?I(t,e,i):f(t,e,i)}function C(t){return"number"==typeof t&&!isNaN(t)}function y(t,e){const i=t.length-1;let r,n,s=0,o=i,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),r=t[a],n=t[a+1],r<=e){if(a===i||e<n)return a;s=a+1}else{if(!(r>e))throw new Error("Input is not a number.");o=a-1}return 0}function A(t){return t-Math.fround(t)}function b(){return devicePixelRatio||1}function S(t,e){if(!t)return!1;if(e=e||b(),t instanceof HTMLCanvasElement){const i=t.clientWidth*e,r=t.clientHeight*e;if(i<=0||r<=0)return!1;if(t.width!==i||t.height!==r)return t.width=i,t.height=r,!0}return!1}function Q(t,e={}){function i(t){console.error(t.statusMessage)}const r=["webgl","experimental-webgl"];let n=null;t.addEventListener("webglcontextcreationerror",i,!1);for(let i=0;i<r.length;++i){try{n=t.getContext(r[i],e)}catch(t){}if(n)break}return t.removeEventListener("webglcontextcreationerror",i,!1),n&&n.getExtension("OES_texture_float")?n:null}function E(t,e={}){return Object.keys(e).map(i=>{e[i]&&(t=t.replace(new RegExp(i,"g"),`${e[i]} \n`))}),t}function U(t,e,i){const r=t.createShader(e);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r)||"";throw t.deleteShader(r),new Error(e)}return r}function w(t,e,i){const r=U(t,t.VERTEX_SHADER,e),n=U(t,t.FRAGMENT_SHADER,i),s=t.createProgram();if(null!==s&&(t.attachShader(s,r),t.attachShader(s,n),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)))throw new Error(t.getProgramInfoLog(s)||"");return s}function G(t,e,i,r,n){const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),i instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,n,0,t.RGBA,t.UNSIGNED_BYTE,i):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.bindTexture(t.TEXTURE_2D,null),s}function R(t,e){const i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),e&&t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i}function M(t,e,i=1,r=0,n){const[s,o,a,l]=e;let c=0;t.clearColor(s,o,a,l),c|=t.COLOR_BUFFER_BIT,void 0!==i&&(t.clearDepth(i),c|=t.DEPTH_BUFFER_BIT),void 0!==r&&(t.clearStencil(0|r),c|=t.STENCIL_BUFFER_BIT),t.clear(c)}function T(t){return new Promise((e,i)=>{t||i(new Event("url is null"));const r=new Image;r.crossOrigin="anonymous",r.onload=(()=>e(r)),r.onerror=i,r.src=t,r.complete&&e(r)})}function L(t,e,i,r,n,s){const o=e-t,a=r-i,l=o/2,c=a/2,h=Math.floor(n),g=Math.floor(s),u=h+1,d=g+1,p=o/h,m=a/g,I=[],B=[],x=[],f=[],F=[];for(let e=0;e<d;e++){const r=e*m;for(let n=0;n<u;n++){const s=n*p,u=t+s/l/2*o,d=i+r/c/2*a;x.push(u,d,0),f.push(A(u),A(d),0),F.push(n/h,e/g)}}for(let t=0;t<g;t++)for(let e=0;e<h;e++){const i=e+u*t,r=e+u*(t+1),n=e+1+u*(t+1),s=e+1+u*t;I.push(i,r,s),I.push(r,n,s)}for(let t=0,e=I.length;t<e;t+=3){const e=I[t],i=I[t+1],r=I[t+2];B.push(e,i,i,r,r,e)}return{uvs:{data:F,size:2},elements:{data:I,count:I.length},wireframeElements:{data:B,count:B.length},position:{data:x,size:3},positionLow:{data:f,size:3}}}function _(t){if(Array.isArray(t)&&t.length>3){const e=t[0],i=t[1],r=[];for(let e=3;e<t.length;e+=2){const i=t[e],n=t[e+1];r.push({key:i,value:n})}return{operator:e,interpolation:{name:i[0],base:i[1]},input:r}}return console.warn("[wind-core]: style-parser style config invalid"),{}}function W(t){if(Array.isArray(t)&&t.length>3){const e=t[0],i=t[1],r=[];for(let e=3;e<t.length;e+=2){const i=t[e],n=t[e+1];r.push({key:i,value:n})}return{operator:e,interpolation:{name:i[0],base:i[1]},input:r}}return console.warn("[wind-core]: style-parser style config invalid"),{}}function X(t,e){const i=document.createElement("canvas"),r=i.getContext("2d");i.width=256,i.height=1;const{input:n}=_(e);if(r&&n&&Array.isArray(n)){const e=n.map(t=>parseFloat(t.key)),i=[Math.min(...e),Math.max(...e)],[s,o]=[t[0]||i[0],t[1]||i[1]],a=r.createLinearGradient(0,0,256,0);for(let t=0;t<n.length;t+=1){const e=n[t].key,i=n[t].value;a.addColorStop((e-s)/(o-s),i)}return r.fillStyle=a,r.fillRect(0,0,256,1),{data:new Uint8Array(r.getImageData(0,0,256,1).data),colorRange:i}}return{}}function V(t,e,i,r){const n=r-i,s=t-i;return 0===n?0:1===e?s/n:(Math.pow(e,s)-1)/(Math.pow(e,n)-1)}function D(t,e,i,r){let n=0;return"exponential"===t.name?n=V(e,t.base,i,r):"linear"===t.name?n=V(e,1,i,r):"cubic-bezier"===t.name&&console.warn("interpolationFactor"),n}function Y(t,e,i){return t*(1-i)+e*i}function Z(t,e,i,r,n){const s=`${t}_${i}`,o=r[i];if(C(o))return pt[s]&&delete pt[s],o;if(o&&Array.isArray(o)&&(!pt[s]||n)&&(pt[s]=W(o)),pt[s]){const{input:t,interpolation:i}=pt[s]||{};if(t&&Array.isArray(t)){const r=t.map(t=>t.key),n=t.map(t=>t.value);if(e<=r[0])return n[0];const s=r.length;if(e>=r[s-1])return n[s-1];const o=y(r,e),a=r.length-1,l=r[o],c=r[o>=a?a:o+1],h=D(i,e,l,c),g=n[o],u=n[o>=a?a:o+1];return Y(g,u,h)}return 1}return 1}function N(t,e){const i=e[0],r=e[1];return t[0]<=i&&i<=t[2]&&t[1]<=r&&r<=t[3]}function P(t){return t[2]-t[0]}function z(t,e,i){const r=t.length,n=i>1?i:2;let s=e;void 0===s&&(s=n>2?t.slice():new Array(r));for(let e=0;e<r;e+=n)s[e]=180*t[e]/20037508.342789244,s[e+1]=360*Math.atan(Math.exp(t[e+1]/6378137))/Math.PI-90;return s}function O(t,e,i,r,n){return n?(n[0]=t,n[1]=e,n[2]=i,n[3]=r,n):[t,e,i,r]}function k(t,e,i){const r=Math.min.apply(null,t),n=Math.min.apply(null,e),s=Math.max.apply(null,t),o=Math.max.apply(null,e);return O(r,n,s,o,i)}function j(t,e,i,r){let n=[];if(r>1){const e=t[2]-t[0],i=t[3]-t[1];for(let s=0;s<r;++s)n.push(t[0]+e*s/r,t[1],t[2],t[1]+i*s/r,t[2]-e*s/r,t[3],t[0],t[3]-i*s/r)}else n=[t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]];e(n,n,2);const s=[],o=[];for(let t=0,e=n.length;t<e;t+=2)s.push(n[t]),o.push(n[t+1]);return k(s,o,i)}function K(t,e){return j(t,z,void 0,e)}function H(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function J(t,e,i,r){return t.coordToPointAtRes?t.coordToPointAtRes(e,i,r):t.coordinateToPoint(e,i,r)}function q(t){et[t]||(console.warn("[maptalks-wind]: ",t),et[t]=!0)}const $=Object.prototype.hasOwnProperty,tt="undefined"!=typeof Symbol?Symbol.toStringTag:void 0,et={};class it{constructor(t,e){this.u=t,this.v=e,this.m=this.magnitude()}magnitude(){return Math.sqrt(this.u**2+this.v**2)}directionTo(){const t=Math.atan2(this.u,this.v);let e=t*(180/Math.PI);return e<0&&(e+=360),e}directionFrom(){const t=this.directionTo();return(t+180)%360}}class rt{constructor(t){this.grid=[],this.xmin=t.xmin,this.xmax=t.xmax,this.ymin=t.ymin,this.ymax=t.ymax,this.cols=t.cols,this.rows=t.rows,this.us=t.us,this.vs=t.vs,this.deltaX=t.deltaX,this.deltaY=t.deltaY,this.flipY=Boolean(t.flipY),this.ymin=Math.min(t.ymax,t.ymin),this.ymax=Math.max(t.ymax,t.ymin),this.deltaY<0&&this.ymin<this.ymax||(void 0===t.flipY&&(this.flipY=!0),console.warn("[wind-core]: The data is flipY")),this.isFields=!0;const e=Math.ceil((this.xmax-this.xmin)/t.deltaX),i=Math.ceil((this.ymax-this.ymin)/t.deltaY);e===this.cols&&i===this.rows||console.warn("[wind-core]: The data grid not equal"),this.isContinuous=Math.floor(this.cols*t.deltaX)>=360,this.translateX="translateX"in t?t.translateX:this.xmax>180,"wrappedX"in t&&h("[wind-core]: ","`wrappedX` namespace will deprecated please use `translateX` insteadÔºÅ"),this.wrapX=Boolean(t.wrapX),this.grid=this.buildGrid(),this.range=this.calculateRange()}buildGrid(){let t=[],e=0;const{rows:i,cols:r,us:n,vs:s}=this;for(let o=0;o<i;o++){const i=[];for(let t=0;t<r;t++,e++){let r=n[e],o=s[e],a=this.isValid(r)&&this.isValid(o);i[t]=a?new it(r,o):null}this.isContinuous&&i.push(i[0]),t[o]=i}return t}release(){this.grid=[]}extent(){return[this.xmin,this.ymin,this.xmax,this.ymax]}bilinearInterpolateVector(t,e,i,r,n,s){const o=1-t,a=1-e,l=o*a,c=t*a,h=o*e,g=t*e,u=i.u*l+r.u*c+n.u*h+s.u*g,d=i.v*l+r.v*c+n.v*h+s.v*g;return new it(u,d)}calculateRange(){if(!this.grid||!this.grid[0])return;const t=this.grid.length,e=this.grid[0].length;let i,r;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const e=this.grid[n][t];if(null!==e){const t=e.m||e.magnitude();void 0===i?i=t:void 0===r?(r=t,i=Math.min(i,r),r=Math.max(i,r)):(i=Math.min(t,i),r=Math.max(t,r))}}return[i,r]}isValid(t){return null!=t}getWrappedLongitudes(){let t=this.xmin,e=this.xmax;return this.translateX&&(this.isContinuous?(t=-180,e=180):(e=this.xmax-360,t=this.xmin-360)),[t,e]}contains(t,e){const[i,r]=this.getWrappedLongitudes();let n,s=t>=i&&t<=r;return n=this.deltaY>=0?e>=this.ymin&&e<=this.ymax:e>=this.ymax&&e<=this.ymin,s&&n}getDecimalIndexes(t,e){const i=g(t-this.xmin,360)/this.deltaX;if(this.flipY){const t=(this.ymax-e)/this.deltaY;return[i,t]}{const t=(this.ymin+e)/this.deltaY;return[i,t]}}valueAt(t,e){let i=!1;if(this.wrapX?i=!0:this.contains(t,e)&&(i=!0),!i)return null;const r=this.getDecimalIndexes(t,e);let n=Math.floor(r[0]),s=Math.floor(r[1]);const o=this.clampColumnIndex(n),a=this.clampRowIndex(s);return this.valueAtIndexes(o,a)}interpolatedValueAt(t,e){let i=!1;if(this.wrapX?i=!0:this.contains(t,e)&&(i=!0),!i)return null;let[r,n]=this.getDecimalIndexes(t,e);return this.interpolatePoint(r,n)}hasValueAt(t,e){let i=this.valueAt(t,e);return null!==i}interpolatePoint(t,e){const i=this.getFourSurroundingIndexes(t,e),[r,n,s,o]=i;let a=this.getFourSurroundingValues(r,n,s,o);if(a){const[i,n,o,l]=a;return this.bilinearInterpolateVector(t-r,e-s,i,n,o,l)}return null}clampColumnIndex(t){let e=t;t<0&&(e=0);let i=this.cols-1;return t>i&&(e=i),e}clampRowIndex(t){let e=t;t<0&&(e=0);let i=this.rows-1;return t>i&&(e=i),e}getFourSurroundingIndexes(t,e){let i=Math.floor(t),r=i+1;this.isContinuous&&r>=this.cols&&(r=0),r=this.clampColumnIndex(r);let n=this.clampRowIndex(Math.floor(e)),s=this.clampRowIndex(n+1);return[i,r,n,s]}getFourSurroundingValues(t,e,i,r){let n;if(n=this.grid[i]){const i=n[t],s=n[e];if(this.isValid(i)&&this.isValid(s)&&(n=this.grid[r])){const r=n[t],o=n[e];if(this.isValid(r)&&this.isValid(o))return[i,s,r,o]}}return null}valueAtIndexes(t,e){return this.grid[e][t]}lonLatAtIndexes(t,e){let i=this.longitudeAtX(t),r=this.latitudeAtY(e);return[i,r]}longitudeAtX(t){let e=this.deltaX/2,i=this.xmin+e+t*this.deltaX;return this.translateX&&(i=i>180?i-360:i),i}latitudeAtY(t){let e=this.deltaY/2;return this.ymax-e-t*this.deltaY}randomize(t={},e,i,r){let n=Math.random()*(e||this.cols)|0,s=Math.random()*(i||this.rows)|0;const o=r([n,s]);return null!==o?(t.x=o[0],t.y=o[1]):(t.x=this.longitudeAtX(n),t.y=this.latitudeAtY(s)),t}checkFields(){return this.isFields}}const nt={globalAlpha:.9,lineWidth:1,colorScale:"#fff",velocityScale:.04,maxAge:90,paths:800,frameRate:20,useCoordsDraw:!0,gpet:!0};class st{constructor(t,e,i){if(this.particles=[],this.generated=!1,this.ctx=t,!this.ctx)throw new Error("ctx error");this.animate=this.animate.bind(this),this.setOptions(e),i&&this.updateData(i)}setOptions(t){this.options={...nt,...t};const{width:e,height:i}=this.ctx.canvas;"particleAge"in t&&!("maxAge"in t)&&o(this.options.particleAge)&&(this.options.maxAge=this.options.particleAge),"particleMultiplier"in t&&!("paths"in t)&&o(this.options.particleMultiplier)&&(this.options.paths=Math.round(e*i*this.options.particleMultiplier)),this.prerender()}getOptions(){return this.options}updateData(t){this.field=t,this.generated&&(this.particles=this.prepareParticlePaths())}project(...t){throw new Error("project must be overriden")}unproject(...t){throw new Error("unproject must be overriden")}intersectsCoordinate(t){throw new Error("must be overriden")}clearCanvas(){this.stop(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.forceStop=!1}start(){this.starting=!0,this.forceStop=!1,this.then=Date.now(),this.animate()}stop(){cancelAnimationFrame(this.animationLoop),this.starting=!1,this.forceStop=!0}animate(){this.animationLoop&&cancelAnimationFrame(this.animationLoop),this.animationLoop=requestAnimationFrame(this.animate);const t=Date.now(),e=t-this.then;e>this.options.frameRate&&(this.then=t-e%this.options.frameRate,this.render())}prerender(){this.generated=!1,this.field&&(this.particles=this.prepareParticlePaths(),this.generated=!0,this.starting||this.forceStop||(this.starting=!0,this.then=Date.now(),this.animate()))}render(){this.moveParticles(),this.drawParticles(),this.postrender()}postrender(){}moveParticles(){const{width:t,height:e}=this.ctx.canvas,i=this.particles,n=this.options.maxAge,s=r(this.options.velocityScale)?this.options.velocityScale():this.options.velocityScale;let o=0;const a=i.length;for(;o<a;o++){const r=i[o];r.age>n&&(r.age=0,this.field.randomize(r,t,e,this.unproject));const a=r.x,l=r.y,c=this.field.interpolatedValueAt(a,l);if(null===c)r.age=n;else{const t=a+c.u*s,e=l+c.v*s;this.field.hasValueAt(t,e)?(r.xt=t,r.yt=e,r.m=c.m):(r.x=t,r.y=e,r.age=n)}r.age++}}fadeIn(){const t=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="destination-in",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.globalCompositeOperation=t}drawParticles(){const t=this.particles;this.fadeIn(),this.ctx.globalAlpha=this.options.globalAlpha,this.ctx.fillStyle=`rgba(0, 0, 0, ${this.options.globalAlpha})`,this.ctx.lineWidth=o(this.options.lineWidth)?this.options.lineWidth:1,this.ctx.strokeStyle=s(this.options.colorScale)?this.options.colorScale:"#fff";let e=0;const i=t.length;if(this.field&&i>0){let r,n;for(u(this.options.minVelocity)&&u(this.options.maxVelocity)?(r=this.options.minVelocity,n=this.options.maxVelocity):[r,n]=this.field.range;e<i;e++)this[this.options.useCoordsDraw?"drawCoordsParticle":"drawPixelParticle"](t[e],r,n)}}drawPixelParticle(t,e,i){const n=[t.x,t.y],s=[t.xt,t.yt];if(s&&n&&u(s[0])&&u(s[1])&&u(n[0])&&u(n[1])&&t.age<=this.options.maxAge){if(this.ctx.beginPath(),this.ctx.moveTo(n[0],n[1]),this.ctx.lineTo(s[0],s[1]),r(this.options.colorScale))this.ctx.strokeStyle=this.options.colorScale(t.m);else if(Array.isArray(this.options.colorScale)){const r=p(t.m,e,i,this.options.colorScale);this.ctx.strokeStyle=this.options.colorScale[r]}r(this.options.lineWidth)&&(this.ctx.lineWidth=this.options.lineWidth(t.m)),t.x=t.xt,t.y=t.yt,this.ctx.stroke()}}drawCoordsParticle(t,e,i){const n=[t.x,t.y],s=[t.xt,t.yt];if(s&&n&&u(s[0])&&u(s[1])&&u(n[0])&&u(n[1])&&this.intersectsCoordinate(s)&&t.age<=this.options.maxAge){const o=this.project(n),a=this.project(s);if(o&&a){if(this.ctx.beginPath(),this.ctx.moveTo(o[0],o[1]),this.ctx.lineTo(a[0],a[1]),t.x=t.xt,t.y=t.yt,r(this.options.colorScale))this.ctx.strokeStyle=this.options.colorScale(t.m);else if(Array.isArray(this.options.colorScale)){const r=p(t.m,e,i,this.options.colorScale);this.ctx.strokeStyle=this.options.colorScale[r]}r(this.options.lineWidth)&&(this.ctx.lineWidth=this.options.lineWidth(t.m)),this.ctx.stroke()}}}prepareParticlePaths(){const{width:t,height:e}=this.ctx.canvas,i="function"==typeof this.options.paths?this.options.paths(this):this.options.paths,r=[];if(!this.field)return[];let n=0;for(;n<i;n++)r.push(this.field.randomize({age:this.randomize()},t,e,this.unproject));return r}randomize(){return Math.floor(Math.random()*this.options.maxAge)}}st.Field=rt;var ot=null;try{var at="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");ot=at.Worker}catch(t){}var lt="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),ct=v("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZnVuY3Rpb24gY2FsY01pbk1heChhcnJheSkgewogICAgbGV0IG1pbiA9IEluZmluaXR5OwogICAgbGV0IG1heCA9IEluZmluaXR5OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB2YWwgPSBhcnJheVtpXTsKICAgICAgaWYgKG1pbiA9PT0gSW5maW5pdHkpIHsKICAgICAgICBtaW4gPSB2YWw7CiAgICAgIH0gZWxzZSBpZiAobWF4ID09PSBJbmZpbml0eSkgewogICAgICAgIG1heCA9IHZhbDsKICAgICAgICBtaW4gPSBNYXRoLm1pbihtaW4sIG1heCk7CiAgICAgICAgbWF4ID0gTWF0aC5tYXgobWluLCBtYXgpOwogICAgICB9IGVsc2UgewogICAgICAgIG1pbiA9IE1hdGgubWluKHZhbCwgbWluKTsKICAgICAgICBtYXggPSBNYXRoLm1heCh2YWwsIG1heCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbbWluLCBtYXhdOwogIH0KCiAgY29uc3QgY3R4ID0gc2VsZjsKICBjdHguYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGFzeW5jICh7IGRhdGE6IHBheWxvYWQgfSkgPT4gewogICAgY29uc3QgcmVuZGVyRm9ybSA9IHBheWxvYWRbMF07CiAgICBpZiAocmVuZGVyRm9ybSA9PT0gInJnIikgewogICAgICBjb25zdCB1RGF0YSA9IHBheWxvYWRbMV07CiAgICAgIGNvbnN0IHZEYXRhID0gcGF5bG9hZFsyXTsKICAgICAgY29uc3QgW3VNaW4sIHVNYXhdID0gY2FsY01pbk1heCh1RGF0YSk7CiAgICAgIGNvbnN0IFt2TWluLCB2TWF4XSA9IGNhbGNNaW5NYXgodkRhdGEpOwogICAgICBjb25zdCB2ZWxvY2l0eURhdGEgPSBuZXcgVWludDhBcnJheSh1RGF0YS5sZW5ndGggKiA0KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1RGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHIgPSAyNTUgKiAodURhdGFbaV0gLSB1TWluKSAvICh1TWF4IC0gdU1pbik7CiAgICAgICAgY29uc3QgZyA9IDI1NSAqICh2RGF0YVtpXSAtIHZNaW4pIC8gKHZNYXggLSB2TWluKTsKICAgICAgICB2ZWxvY2l0eURhdGEuc2V0KFtyLCBnLCAwLCAyNTVdLCBpICogNCk7CiAgICAgIH0KICAgICAgY3R4LnBvc3RNZXNzYWdlKFt2ZWxvY2l0eURhdGEuYnVmZmVyLCB1TWluLCB1TWF4LCB2TWluLCB2TWF4XSwgW3ZlbG9jaXR5RGF0YS5idWZmZXJdKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHNpbmdsZURhdGEgPSBwYXlsb2FkWzFdOwogICAgICBjb25zdCBbbWluLCBtYXhdID0gY2FsY01pbk1heChzaW5nbGVEYXRhKTsKICAgICAgY29uc3QgdmVsb2NpdHlEYXRhID0gbmV3IFVpbnQ4QXJyYXkoc2luZ2xlRGF0YS5sZW5ndGggKiA0KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaW5nbGVEYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgciA9IDI1NSAqIChzaW5nbGVEYXRhW2ldIC0gbWluKSAvIChtYXggLSBtaW4pOwogICAgICAgIHZlbG9jaXR5RGF0YS5zZXQoW3IsIDAsIDAsIDI1NV0sIGkgKiA0KTsKICAgICAgfQogICAgICBjdHgucG9zdE1lc3NhZ2UoW3ZlbG9jaXR5RGF0YS5idWZmZXIsIG1pbiwgbWF4XSwgW3ZlbG9jaXR5RGF0YS5idWZmZXJdKTsKICAgIH0KICB9KTsKCn0pKCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPURhdGFQcm9jZXNzZS5qcy5tYXAKCg==","data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YVByb2Nlc3NlLmpzIiwic291cmNlcyI6WyJ3b3JrZXI6Ly93ZWItd29ya2VyL3V0aWxzL2NvbW1vbi50cyIsIndvcmtlcjovL3dlYi13b3JrZXIvd29ya2Vycy9EYXRhUHJvY2Vzc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIGNhbGNNaW5NYXgoYXJyYXk6IG51bWJlcltdKTogW251bWJlciwgbnVtYmVyXSB7XG4gIGxldCBtaW4gPSBJbmZpbml0eTtcbiAgbGV0IG1heCA9IEluZmluaXR5O1xuICAvLyBAZnJvbTogaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM1NDQ0NzYvaG93LXRvLWZpbmQtbWF4LWFuZC1taW4taW4tYXJyYXktdXNpbmctbWluaW11bS1jb21wYXJpc29uc1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgdmFsID0gYXJyYXlbaV07XG5cbiAgICBpZiAobWluID09PSBJbmZpbml0eSkge1xuICAgICAgbWluID0gdmFsO1xuICAgIH0gZWxzZSBpZiAobWF4ID09PSBJbmZpbml0eSkge1xuICAgICAgbWF4ID0gdmFsO1xuICAgICAgLy8gdXBkYXRlIG1pbiBtYXhcbiAgICAgIC8vIDEuIFBpY2sgMiBlbGVtZW50cyhhLCBiKSwgY29tcGFyZSB0aGVtLiAoc2F5IGEgPiBiKVxuICAgICAgbWluID0gTWF0aC5taW4obWluLCBtYXgpO1xuICAgICAgbWF4ID0gTWF0aC5tYXgobWluLCBtYXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyAyLiBVcGRhdGUgbWluIGJ5IGNvbXBhcmluZyAobWluLCBiKVxuICAgICAgLy8gMy4gVXBkYXRlIG1heCBieSBjb21wYXJpbmcgKG1heCwgYSlcbiAgICAgIG1pbiA9IE1hdGgubWluKHZhbCwgbWluKTtcbiAgICAgIG1heCA9IE1hdGgubWF4KHZhbCwgbWF4KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIFttaW4sIG1heF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc051bWJlcih2YWw6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHZhbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1ZhbGlkZSh2YWw6IGFueSk6IGJvb2xlYW4ge1xuICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgJiYgdmFsICE9PSBudWxsICYmICFpc05hTih2YWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFN0b3BMZXNzVGhhbk9yRXF1YWxUbyhzdG9wczogbnVtYmVyW10sIGlucHV0OiBudW1iZXIpIHtcbiAgY29uc3QgbGFzdEluZGV4ID0gc3RvcHMubGVuZ3RoIC0gMTtcbiAgbGV0IGxvd2VySW5kZXggPSAwO1xuICBsZXQgdXBwZXJJbmRleCA9IGxhc3RJbmRleDtcbiAgbGV0IGN1cnJlbnRJbmRleCA9IDA7XG4gIGxldCBjdXJyZW50VmFsdWU7XG4gIGxldCBuZXh0VmFsdWU7XG5cbiAgd2hpbGUgKGxvd2VySW5kZXggPD0gdXBwZXJJbmRleCkge1xuICAgIGN1cnJlbnRJbmRleCA9IE1hdGguZmxvb3IoKGxvd2VySW5kZXggKyB1cHBlckluZGV4KSAvIDIpO1xuICAgIGN1cnJlbnRWYWx1ZSA9IHN0b3BzW2N1cnJlbnRJbmRleF07XG4gICAgbmV4dFZhbHVlID0gc3RvcHNbY3VycmVudEluZGV4ICsgMV07XG5cbiAgICBpZiAoY3VycmVudFZhbHVlIDw9IGlucHV0KSB7XG4gICAgICBpZiAoY3VycmVudEluZGV4ID09PSBsYXN0SW5kZXggfHwgaW5wdXQgPCBuZXh0VmFsdWUpIHtcbiAgICAgICAgLy8gU2VhcmNoIGNvbXBsZXRlXG4gICAgICAgIHJldHVybiBjdXJyZW50SW5kZXg7XG4gICAgICB9XG5cbiAgICAgIGxvd2VySW5kZXggPSBjdXJyZW50SW5kZXggKyAxO1xuICAgIH0gZWxzZSBpZiAoY3VycmVudFZhbHVlID4gaW5wdXQpIHtcbiAgICAgIHVwcGVySW5kZXggPSBjdXJyZW50SW5kZXggLSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lucHV0IGlzIG5vdCBhIG51bWJlci4nKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gMDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZwNjRMb3dQYXJ0KHg6IG51bWJlcikge1xuICByZXR1cm4geCAtIE1hdGguZnJvdW5kKHgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF0NEludmVydChvdXQ6IG51bWJlcltdLCBhOiBudW1iZXJbXSkge1xuICBjb25zdCBhMDAgPSBhWzBdO1xuICBjb25zdCBhMDEgPSBhWzFdO1xuICBjb25zdCBhMDIgPSBhWzJdO1xuICBjb25zdCBhMDMgPSBhWzNdO1xuICBjb25zdCBhMTAgPSBhWzRdO1xuICBjb25zdCBhMTEgPSBhWzVdO1xuICBjb25zdCBhMTIgPSBhWzZdO1xuICBjb25zdCBhMTMgPSBhWzddO1xuICBjb25zdCBhMjAgPSBhWzhdO1xuICBjb25zdCBhMjEgPSBhWzldO1xuICBjb25zdCBhMjIgPSBhWzEwXTtcbiAgY29uc3QgYTIzID0gYVsxMV07XG4gIGNvbnN0IGEzMCA9IGFbMTJdO1xuICBjb25zdCBhMzEgPSBhWzEzXTtcbiAgY29uc3QgYTMyID0gYVsxNF07XG4gIGNvbnN0IGEzMyA9IGFbMTVdO1xuXG4gIGNvbnN0IGIwMCA9IGEwMCAqIGExMSAtIGEwMSAqIGExMDtcbiAgY29uc3QgYjAxID0gYTAwICogYTEyIC0gYTAyICogYTEwO1xuICBjb25zdCBiMDIgPSBhMDAgKiBhMTMgLSBhMDMgKiBhMTA7XG4gIGNvbnN0IGIwMyA9IGEwMSAqIGExMiAtIGEwMiAqIGExMTtcbiAgY29uc3QgYjA0ID0gYTAxICogYTEzIC0gYTAzICogYTExO1xuICBjb25zdCBiMDUgPSBhMDIgKiBhMTMgLSBhMDMgKiBhMTI7XG4gIGNvbnN0IGIwNiA9IGEyMCAqIGEzMSAtIGEyMSAqIGEzMDtcbiAgY29uc3QgYjA3ID0gYTIwICogYTMyIC0gYTIyICogYTMwO1xuICBjb25zdCBiMDggPSBhMjAgKiBhMzMgLSBhMjMgKiBhMzA7XG4gIGNvbnN0IGIwOSA9IGEyMSAqIGEzMiAtIGEyMiAqIGEzMTtcbiAgY29uc3QgYjEwID0gYTIxICogYTMzIC0gYTIzICogYTMxO1xuICBjb25zdCBiMTEgPSBhMjIgKiBhMzMgLSBhMjMgKiBhMzI7XG5cbiAgLy8gQ2FsY3VsYXRlIHRoZSBkZXRlcm1pbmFudFxuICBsZXQgZGV0ID1cbiAgICBiMDAgKiBiMTEgLSBiMDEgKiBiMTAgKyBiMDIgKiBiMDkgKyBiMDMgKiBiMDggLSBiMDQgKiBiMDcgKyBiMDUgKiBiMDY7XG5cbiAgaWYgKCFkZXQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBkZXQgPSAxLjAgLyBkZXQ7XG5cbiAgb3V0WzBdID0gKGExMSAqIGIxMSAtIGExMiAqIGIxMCArIGExMyAqIGIwOSkgKiBkZXQ7XG4gIG91dFsxXSA9IChhMDIgKiBiMTAgLSBhMDEgKiBiMTEgLSBhMDMgKiBiMDkpICogZGV0O1xuICBvdXRbMl0gPSAoYTMxICogYjA1IC0gYTMyICogYjA0ICsgYTMzICogYjAzKSAqIGRldDtcbiAgb3V0WzNdID0gKGEyMiAqIGIwNCAtIGEyMSAqIGIwNSAtIGEyMyAqIGIwMykgKiBkZXQ7XG4gIG91dFs0XSA9IChhMTIgKiBiMDggLSBhMTAgKiBiMTEgLSBhMTMgKiBiMDcpICogZGV0O1xuICBvdXRbNV0gPSAoYTAwICogYjExIC0gYTAyICogYjA4ICsgYTAzICogYjA3KSAqIGRldDtcbiAgb3V0WzZdID0gKGEzMiAqIGIwMiAtIGEzMCAqIGIwNSAtIGEzMyAqIGIwMSkgKiBkZXQ7XG4gIG91dFs3XSA9IChhMjAgKiBiMDUgLSBhMjIgKiBiMDIgKyBhMjMgKiBiMDEpICogZGV0O1xuICBvdXRbOF0gPSAoYTEwICogYjEwIC0gYTExICogYjA4ICsgYTEzICogYjA2KSAqIGRldDtcbiAgb3V0WzldID0gKGEwMSAqIGIwOCAtIGEwMCAqIGIxMCAtIGEwMyAqIGIwNikgKiBkZXQ7XG4gIG91dFsxMF0gPSAoYTMwICogYjA0IC0gYTMxICogYjAyICsgYTMzICogYjAwKSAqIGRldDtcbiAgb3V0WzExXSA9IChhMjEgKiBiMDIgLSBhMjAgKiBiMDQgLSBhMjMgKiBiMDApICogZGV0O1xuICBvdXRbMTJdID0gKGExMSAqIGIwNyAtIGExMCAqIGIwOSAtIGExMiAqIGIwNikgKiBkZXQ7XG4gIG91dFsxM10gPSAoYTAwICogYjA5IC0gYTAxICogYjA3ICsgYTAyICogYjA2KSAqIGRldDtcbiAgb3V0WzE0XSA9IChhMzEgKiBiMDEgLSBhMzAgKiBiMDMgLSBhMzIgKiBiMDApICogZGV0O1xuICBvdXRbMTVdID0gKGEyMCAqIGIwMyAtIGEyMSAqIGIwMSArIGEyMiAqIGIwMCkgKiBkZXQ7XG5cbiAgcmV0dXJuIG91dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zZm9ybU1hdDQob3V0OiBudW1iZXJbXSwgYTogbnVtYmVyW10sIG06IG51bWJlcltdKSB7XG4gIGNvbnN0IHggPSBhWzBdO1xuICBjb25zdCB5ID0gYVsxXTtcbiAgY29uc3QgeiA9IGFbMl07XG4gIGNvbnN0IHcgPSBhWzNdO1xuICBvdXRbMF0gPSBtWzBdICogeCArIG1bNF0gKiB5ICsgbVs4XSAqIHogKyBtWzEyXSAqIHc7IC8vIDBcbiAgb3V0WzFdID0gbVsxXSAqIHggKyBtWzVdICogeSArIG1bOV0gKiB6ICsgbVsxM10gKiB3OyAvLyAwXG4gIG91dFsyXSA9IG1bMl0gKiB4ICsgbVs2XSAqIHkgKyBtWzEwXSAqIHogKyBtWzE0XSAqIHc7IC8vIDBcbiAgb3V0WzNdID0gbVszXSAqIHggKyBtWzddICogeSArIG1bMTFdICogeiArIG1bMTVdICogdzsgLy8gMVxuICByZXR1cm4gb3V0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RXllKG1hdHJpeDogbnVtYmVyW10pIHtcbiAgY29uc3QgZGVmYXVsdE1hdDQgPSBbMSwgMCwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMCwgMV07IC8vIGluc3RlZCBvZiBtYXQ0LmNyZWF0ZSgpXG4gIGxldCBleWUgPSB0cmFuc2Zvcm1NYXQ0KFxuICAgIFtdLFxuICAgIFswLCAwLCAwLCAxXSxcbiAgICBtYXQ0SW52ZXJ0KGRlZmF1bHRNYXQ0LCBtYXRyaXgpIGFzIG51bWJlcltdLFxuICApO1xuICBjb25zdCBjbGlwVyA9IDEuMCAvIGV5ZVszXTtcbiAgZXllID0gZXllLm1hcCgoaXRlbTogbnVtYmVyKSA9PiBpdGVtIC8gZXllWzNdKTtcbiAgZXllWzNdID0gY2xpcFc7XG4gIHJldHVybiBleWU7XG59XG4iLCJpbXBvcnQgeyBjYWxjTWluTWF4IH0gZnJvbSAnLi4vdXRpbHMvY29tbW9uJztcblxuY29uc3QgY3R4OiBXb3JrZXIgPSBzZWxmIGFzIGFueTtcblxuY3R4LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBhc3luYyAoeyBkYXRhOiBwYXlsb2FkIH0pID0+IHtcbiAgY29uc3QgcmVuZGVyRm9ybSA9IHBheWxvYWRbMF07XG4gIGlmIChyZW5kZXJGb3JtID09PSAncmcnKSB7XG4gICAgY29uc3QgdURhdGEgPSBwYXlsb2FkWzFdO1xuICAgIGNvbnN0IHZEYXRhID0gcGF5bG9hZFsyXTtcbiAgICBjb25zdCBbdU1pbiwgdU1heF0gPSBjYWxjTWluTWF4KHVEYXRhKTtcbiAgICBjb25zdCBbdk1pbiwgdk1heF0gPSBjYWxjTWluTWF4KHZEYXRhKTtcbiAgICBjb25zdCB2ZWxvY2l0eURhdGEgPSBuZXcgVWludDhBcnJheSh1RGF0YS5sZW5ndGggKiA0KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVEYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCByID0gMjU1ICogKHVEYXRhW2ldIC0gdU1pbikgLyAodU1heCAtIHVNaW4pO1xuICAgICAgY29uc3QgZyA9IDI1NSAqICh2RGF0YVtpXSAtIHZNaW4pIC8gKHZNYXggLSB2TWluKTtcbiAgICAgIHZlbG9jaXR5RGF0YS5zZXQoW3IsIGcsIDAsIDI1NV0sIGkgKiA0KTtcbiAgICB9XG5cbiAgICBjdHgucG9zdE1lc3NhZ2UoW3ZlbG9jaXR5RGF0YS5idWZmZXIsIHVNaW4sIHVNYXgsIHZNaW4sIHZNYXhdLCBbdmVsb2NpdHlEYXRhLmJ1ZmZlcl0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNpbmdsZURhdGEgPSBwYXlsb2FkWzFdO1xuICAgIGNvbnN0IFttaW4sIG1heF0gPSBjYWxjTWluTWF4KHNpbmdsZURhdGEpO1xuICAgIGNvbnN0IHZlbG9jaXR5RGF0YSA9IG5ldyBVaW50OEFycmF5KHNpbmdsZURhdGEubGVuZ3RoICogNCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaW5nbGVEYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCByID0gMjU1ICogKHNpbmdsZURhdGFbaV0gLSBtaW4pIC8gKG1heCAtIG1pbik7XG4gICAgICB2ZWxvY2l0eURhdGEuc2V0KFtyLCAwLCAwLCAyNTVdLCBpICogNCk7XG4gICAgfVxuXG4gICAgY3R4LnBvc3RNZXNzYWdlKFt2ZWxvY2l0eURhdGEuYnVmZmVyLCBtaW4sIG1heF0sIFt2ZWxvY2l0eURhdGEuYnVmZmVyXSk7XG4gIH1cbn0pO1xuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztFQUFPLFNBQVMsV0FBVyxLQUFtQyxFQUFBO0VBQzVELEVBQUEsSUFBSSxHQUFNLEdBQUEsUUFBQSxDQUFBO0VBQ1YsRUFBQSxJQUFJLEdBQU0sR0FBQSxRQUFBLENBQUE7RUFFVixFQUFBLEtBQUEsSUFBUyxDQUFJLEdBQUEsQ0FBQSxFQUFHLENBQUksR0FBQSxLQUFBLENBQU0sUUFBUSxDQUFLLEVBQUEsRUFBQTtFQUNyQyxJQUFBLE1BQU0sTUFBTSxLQUFNLENBQUEsQ0FBQSxDQUFBLENBQUE7RUFFbEIsSUFBQSxJQUFJLFFBQVEsUUFBVSxFQUFBO0VBQ3BCLE1BQU0sR0FBQSxHQUFBLEdBQUEsQ0FBQTtFQUFBLEtBQ1IsTUFBQSxJQUFXLFFBQVEsUUFBVSxFQUFBO0VBQzNCLE1BQU0sR0FBQSxHQUFBLEdBQUEsQ0FBQTtFQUdOLE1BQU0sR0FB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",!1);class ht{constructor(t,e,i,r){this.vertShader="",this.fragShader="",e&&(this.vertShader=e),i&&(this.fragShader=i),this.program=w(t,E(this.vertShader,r),this.fragShader),this.gl=t,this.textureUnit=0,this.uniformSetters=this.createUniformSetters(),this.attribSetters=this.createAttributeSetters(),this.transfromStack=[]}active(){return this.gl.useProgram(this.program),this}deactive(){return this.gl.deleteProgram(this.program),this}getBindPointForSamplerType(t,e){return e===t.SAMPLER_2D?t.TEXTURE_2D:e===t.SAMPLER_CUBE?t.TEXTURE_CUBE_MAP:void 0}createUniformSetter(t,e){const{gl:i}=this,r=i.getUniformLocation(t,e.name),n=e.type,s=e.size>1&&"[0]"===e.name.substr(-3);if(n===i.FLOAT&&s)return function(t){i.uniform1fv(r,t)};if(n===i.FLOAT)return function(t){
i.uniform1f(r,t)};if(n===i.FLOAT_VEC2)return function(t){i.uniform2fv(r,t)};if(n===i.FLOAT_VEC3)return function(t){i.uniform3fv(r,t)};if(n===i.FLOAT_VEC4)return function(t){i.uniform4fv(r,t)};if(n===i.INT&&s)return function(t){i.uniform1iv(r,t)};if(n===i.INT)return function(t){i.uniform1i(r,t)};if(n===i.INT_VEC2)return function(t){i.uniform2iv(r,t)};if(n===i.INT_VEC3)return function(t){i.uniform3iv(r,t)};if(n===i.INT_VEC4)return function(t){i.uniform4iv(r,t)};if(n===i.BOOL)return function(t){i.uniform1iv(r,t)};if(n===i.BOOL_VEC2)return function(t){i.uniform2iv(r,t)};if(n===i.BOOL_VEC3)return function(t){i.uniform3iv(r,t)};if(n===i.BOOL_VEC4)return function(t){i.uniform4iv(r,t)};if(n===i.FLOAT_MAT2)return function(t){i.uniformMatrix2fv(r,!1,t)};if(n===i.FLOAT_MAT3)return function(t){i.uniformMatrix3fv(r,!1,t)};if(n===i.FLOAT_MAT4)return function(t){i.uniformMatrix4fv(r,!1,t)};if((n===i.SAMPLER_2D||n===i.SAMPLER_CUBE)&&s){const t=[];for(let i=0;i<e.size;++i)t.push(this.textureUnit++);return o=this.getBindPointForSamplerType(i,n),a=t,function(t){i.uniform1iv(r,a),t.forEach(function(t,e){i.activeTexture(i.TEXTURE0+a[e]),void 0!==o&&i.bindTexture(o,t)})}}var o,a;if(n===i.SAMPLER_2D||n===i.SAMPLER_CUBE)return function(t,e){return function(n){i.uniform1i(r,e),i.activeTexture(i.TEXTURE0+e),void 0!==t&&i.bindTexture(t,n)}}(this.getBindPointForSamplerType(i,n),this.textureUnit++);throw new Error("unknown type: 0x"+n.toString(16))}createUniformSetters(){const{gl:t}=this;this.textureUnit=0;const e={};if(null!==this.program){const i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let r=0;r<i;++r){const i=t.getActiveUniform(this.program,r);if(!i)break;let n=i.name;"[0]"===n.substr(-3)&&(n=n.substr(0,n.length-3));const s=this.createUniformSetter(this.program,i);e[n]=s}}return e}createAttribSetter(t){const{gl:e}=this;return function(i){e.bindBuffer(e.ARRAY_BUFFER,i.buffer),e.enableVertexAttribArray(t),void 0===i.numComponents&&void 0===i.size||e.vertexAttribPointer(t,i.numComponents||i.size,i.type||e.FLOAT,i.normalize||!1,i.stride||0,i.offset||0)}}createAttributeSetters(){const{gl:t}=this,e={};if(null!==this.program){const i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let r=0;r<i;++r){const i=t.getActiveAttrib(this.program,r);if(!i)break;const n=t.getAttribLocation(this.program,i.name);e[i.name]=this.createAttribSetter(n)}}return e}setAttributes(t,e){return e=e?e.attribSetters||e:this.attribSetters,Object.keys(t).forEach(function(i){const r=e[i];r&&r(t[i])}),this}setUniforms(t,e){return e=e?e.uniformSetters||e:this.uniformSetters,Object.keys(t).forEach(function(i){const r=e[i];r&&r(t[i])}),this}elements(t){return this.elementsBuffer||(this.elementsBuffer=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.elementsBuffer),t.data&&this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,t.data,t.usage||this.gl.STATIC_DRAW),void 0!==t.count&&this.runTimes(t.count),t.primitive&&this.setPrimitive(t.primitive),this}clear(t){return M(this.gl,t),this.transfromStack=[],this}runTimes(t){return this.count=t||0,this}setPrimitive(t){return this.primitive=t||this.gl.TRIANGLES,this}resize(t,e){return void 0===t||void 0===e?(S(this.gl.canvas),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)):this.gl.viewport(0,0,t,e),this}draw(){throw new Error("should override")}translate(){throw new Error("should override")}rotate(){throw new Error("should override")}scale(){throw new Error("should override")}destroyed(){throw new Error("should override")}}var gt="precision highp float;\n#define GLSLIFY 1\nuniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform vec2 u_image_res;uniform vec2 u_range;uniform vec2 u_color_range;uniform vec2 u_display_range;uniform float u_opacity;varying vec2 v_tex_pos;float calcTexture(const vec2 uv){return texture2D(u_image,uv).r;}float bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=calcTexture(vc);float tr=calcTexture(vc+vec2(px.x,0));float bl=calcTexture(vc+vec2(0,px.y));float br=calcTexture(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getValue(const vec2 uv){float min=u_range.x;float max=u_range.y;float r=bilinear(uv);return r*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}void main(){vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=getValue(globalWGS84);float value_t=(value-u_color_range.x)/(u_color_range.y-u_color_range.x);vec2 ramp_pos=vec2(fract(16.0*value_t),floor(16.0*value_t)/16.0);vec4 color=texture2D(u_color_ramp,ramp_pos);bool display=value<u_display_range.y&&value>u_display_range.x;if(display){gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}",ut="#define GLSLIFY 1\nattribute vec3 instancePositions;attribute vec3 instancePositions64Low;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform vec4 u_cameraEye;uniform vec4 u_cameraEye64Low;uniform float u_offset;uniform sampler2D u_image;uniform vec2 u_image_res;uniform vec2 u_range;uniform vec2 u_mapping_range;varying vec2 v_tex_pos;varying float v_value;float calcTexture(const vec2 uv){return texture2D(u_image,uv).r;}float bilinear(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=calcTexture(vc);float tr=calcTexture(vc+vec2(px.x,0));float bl=calcTexture(vc+vec2(0,px.y));float br=calcTexture(vc+px);return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getValue(const vec2 uv){float min=u_mapping_range.x;float max=u_mapping_range.y;float r=bilinear(uv);return r*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}\n#modules-transformZ\nvoid main(){v_tex_pos=a_texCoord;vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=getValue(globalWGS84);float z=transformZ(value,instancePositions);vec4 pos=vec4(instancePositions-u_cameraEye.xyz,0.0);pos+=vec4(instancePositions64Low-u_cameraEye64Low.xyz,0.0);\n#modules-project\n}";class dt extends ht{constructor(t,e,i,r){super(t,e||ut,i||gt,r||{}),this.vertShader=ut,this.fragShader=gt}draw(){if(void 0!==this.checkExt){const t=this.primitive||this.gl.TRIANGLES;this.checkExt?this.gl.drawElements(t,this.count,this.gl.UNSIGNED_INT,0):this.gl.drawElements(t,this.count,this.gl.UNSIGNED_SHORT,0)}else this.checkExt=this.gl.getExtension("OES_element_index_uint");return this}translate(){return this}rotate(){return this}scale(){return this}}const pt={};var mt="precision highp float;\n#define GLSLIFY 1\nuniform sampler2D u_wind;uniform sampler2D u_color_ramp;uniform vec2 u_image_res;uniform vec2 u_wind_min;uniform vec2 u_wind_max;uniform vec2 u_color_range;uniform vec2 u_display_range;uniform float u_opacity;varying vec2 v_tex_pos;vec2 windTexture(const vec2 uv){return texture2D(u_wind,uv).rg;}float bilinearU(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).r;float tr=windTexture(vc+vec2(px.x,0)).r;float bl=windTexture(vc+vec2(0,px.y)).r;float br=windTexture(vc+px).r;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float bilinearV(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).g;float tr=windTexture(vc+vec2(px.x,0.0)).g;float bl=windTexture(vc+vec2(0.0,px.y)).g;float br=windTexture(vc+px).g;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getV(const vec2 uv){float min=u_wind_min.y;float max=u_wind_max.y;float r=bilinearV(uv);return r*(max-min)+min;}float getU(const vec2 uv){float min=u_wind_min.x;float max=u_wind_max.x;float r=bilinearU(uv);return r*(max-min)+min;}float windSpeed(const vec2 uv){float u=getU(uv);float v=getV(uv);return length(vec2(u,v));}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}void main(){vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=windSpeed(globalWGS84);float value_t=(value-u_color_range.x)/(u_color_range.y-u_color_range.x);vec2 ramp_pos=vec2(fract(16.0*value_t),floor(16.0*value_t)/16.0);vec4 color=texture2D(u_color_ramp,ramp_pos);bool display=value<u_display_range.y&&value>u_display_range.x;if(display){gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}else{gl_FragColor=vec4(0.0,0.0,0.0,0.0);}}",It="#define GLSLIFY 1\nattribute vec3 instancePositions;attribute vec3 instancePositions64Low;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform vec4 u_cameraEye;uniform vec4 u_cameraEye64Low;uniform float u_offset;uniform sampler2D u_wind;uniform vec2 u_image_res;uniform vec2 u_wind_min;uniform vec2 u_wind_max;uniform vec2 u_mapping_range;varying vec2 v_tex_pos;varying float v_value;vec2 windTexture(const vec2 uv){return texture2D(u_wind,uv).rg;}float bilinearU(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).r;float tr=windTexture(vc+vec2(px.x,0)).r;float bl=windTexture(vc+vec2(0,px.y)).r;float br=windTexture(vc+px).r;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float bilinearV(const vec2 uv){vec2 px=1.0/u_image_res;vec2 vc=(floor(uv*u_image_res))*px;vec2 f=fract(uv*u_image_res);float tl=windTexture(vc).g;float tr=windTexture(vc+vec2(px.x,0.0)).g;float bl=windTexture(vc+vec2(0.0,px.y)).g;float br=windTexture(vc+px).g;return mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);}float getV(const vec2 uv){float min=u_wind_min.y;float max=u_wind_max.y;float r=bilinearV(uv);return r*(max-min)+min;}float getU(const vec2 uv){float min=u_wind_min.x;float max=u_wind_max.x;float r=bilinearU(uv);return r*(max-min)+min;}float windSpeed(const vec2 uv){float u=getU(uv);float v=getV(uv);float min=u_mapping_range.x;float max=u_mapping_range.y;float val=length(vec2(u,v));return val*(max-min)+min;}const float PI=3.14159265359;vec2 mercatorToWGS84(vec2 xy){float y=radians(180.0-xy.y*360.0);y=360.0/PI*atan(exp(y))-90.0;y=y/-180.0+0.5;return vec2(xy.x,y);}\n#modules-transformZ\nvoid main(){v_tex_pos=a_texCoord;vec2 globalWGS84=mercatorToWGS84(v_tex_pos);float value=windSpeed(globalWGS84);float z=transformZ(value,instancePositions);vec4 pos=vec4(instancePositions-u_cameraEye.xyz,0.0);pos+=vec4(instancePositions64Low-u_cameraEye64Low.xyz,0.0);\n#modules-project\n}";class Bt extends ht{constructor(t,e,i,r){super(t,e||It,i||mt,r||{}),this.vertShader=It,this.fragShader=mt}draw(){if(void 0!==this.checkExt){const t=this.primitive||this.gl.TRIANGLES;this.checkExt?this.gl.drawElements(t,this.count,this.gl.UNSIGNED_INT,0):this.gl.drawElements(t,this.count,this.gl.UNSIGNED_SHORT,0)}else this.checkExt=this.gl.getExtension("OES_element_index_uint");return this}translate(){return this}rotate(){return this}scale(){return this}destroyed(){}}const xt={renderForm:"r",styleSpec:{"fill-color":["interpolate",["linear"],["get","value"],0,"#3288bd",10,"#66c2a5",20,"#abdda4",30,"#e6f598",40,"#fee08b",50,"#fdae61",60,"#f46d43",100,"#d53e4f"],opacity:1},displayRange:[1/0,1/0],mappingRange:[0,0],widthSegments:1,heightSegments:1,wireframe:!1,createPlaneBuffer:(t,e,i)=>{const[r,n,s,o]=[t[0][0],t[2][0],t[0][1],t[1][1]];return L(r,n,s,o,e,i)},injectShaderModules:{"#modules-transformZ":"\nfloat transformZ(float value, vec3 pos) {\n  return 0.0;\n}\n    ","#modules-project":"\ngl_Position = u_matrix * vec4(pos.xy + vec2(u_offset, 0.0), pos.z + z, 1.0);\n    "}};let ft=0;class Ft{constructor(t,e){if(this.gl=t,this.uid=`ScalarFill_${ft}`,ft++,!this.gl)throw new Error("initialize error");e||(e={}),this.options={...xt,...e},this.opacity=this.options.opacity||1}updateOptions(t){this.options={...this.options,...t},this.buildColorRamp(),"function"==typeof this.options.getZoom&&this.setOpacity(Z(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec,!0))}setFillColor(){this.buildColorRamp()}setOpacity(t){this.opacity=t}handleZoom(){"function"==typeof this.options.getZoom&&this.setOpacity(Z(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec))}buildColorRamp(){var t;const{data:e,colorRange:i}=X([],null==(t=this.options.styleSpec)?void 0:t["fill-color"]);i&&(this.colorRange=i),e&&(this.colorRampTexture=G(this.gl,this.gl.NEAREST,e,16,16))}initialize(t){this.drawCommand||("rg"===this.options.renderForm?this.drawCommand=new Bt(t,void 0,void 0,this.options.injectShaderModules):"r"===this.options.renderForm?this.drawCommand=new dt(t,void 0,void 0,this.options.injectShaderModules):console.warn("This type is not supported temporarily")),this.buildColorRamp(),"function"==typeof this.options.getZoom&&this.setOpacity(Z(this.uid,this.options.getZoom(),"opacity",this.options.styleSpec))}initializeVertex(t){let e=0;const i=t.length,r=[];for(;e<i;e++){const i=t[e],n=this.getMercatorCoordinate(i);r.push([n[0],n[1]])}const n=(this.options.createPlaneBuffer||xt.createPlaneBuffer)(r,this.options.widthSegments||1,this.options.heightSegments||1);return{indexes:n.elements.data,wireframeIndexes:n.wireframeElements.data,quadBuffer:R(this.gl,new Float32Array(n.position.data)),quad64LowBuffer:R(this.gl,new Float32Array(n.positionLow.data)),texCoordBuffer:R(this.gl,new Float32Array(n.uvs.data))}}getTextureData(t){return new Promise((e,i)=>{if("image"===t.type&&t.url)T(t.url).then(i=>{const r={width:i.width,height:i.height,texture:G(this.gl,this.gl.LINEAR,i,i.width,i.height),...this.initializeVertex(t.extent)};"rg"===this.options.renderForm?(r.uMin=t.uMin,r.uMax=t.uMax,r.vMin=t.vMin,r.vMax=t.vMax):"r"===this.options.renderForm?(r.min=t.min,r.max=t.max):console.warn("This type is not supported temporarily"),e(r)}).catch(t=>i(t));else if("jsonArray"===t.type&&t.data){const i=t.data;let r;r=t.extent?t.extent:[[i[0].header.lo1,i[0].header.la1],[i[0].header.lo1,i[0].header.la2],[i[0].header.lo2,i[0].header.la1],[i[0].header.lo2,i[0].header.la2]];const n={width:i[0].header.nx,height:i[0].header.ny,...this.initializeVertex(r)};if(this.worker||(this.worker=new ct,this.worker.addEventListener("message",({data:t})=>{"rg"===this.options.renderForm?(n.uMin=t[1],n.uMax=t[2],n.vMin=t[3],n.vMax=t[4],n.texture=G(this.gl,this.gl.LINEAR,new Uint8Array(t[0]),n.width,n.height)):"r"===this.options.renderForm?(n.min=t[1],n.max=t[2],n.texture=G(this.gl,this.gl.LINEAR,new Uint8Array(t[0]),n.width,n.height)):console.warn("This type is not supported temporarily"),e(n)})),"rg"===this.options.renderForm){let t,e;i.forEach(i=>{switch(i.header.parameterCategory+","+i.header.parameterNumber){case"1,2":case"2,2":t=i;break;case"1,3":case"2,3":e=i}});const r=new Float32Array(t.data),n=new Float32Array(e.data);this.worker.postMessage(["rg",r,n])}else if("r"===this.options.renderForm){const t=new Float32Array(i[0].data);this.worker.postMessage(["r",t])}else console.warn("This type is not supported temporarily")}})}setData(t,e){this.gl&&t&&this.getTextureData(t).then(t=>{this.data=t,e&&e(!0),this.data&&this.initialize(this.gl),this.options.triggerRepaint&&(this.handleZoom(),this.options.triggerRepaint())}).catch(t=>{e&&e(!1),console.error(t)})}getData(){return this.data}getMercatorCoordinate([t,e]){return[t,e]}prerender(){}render(t,e,i){if(this.data&&this.drawCommand&&this.data.texture&&this.colorRampTexture){const r=this.opacity,n={u_opacity:C(r)?r:1,u_image_res:[this.data.width,this.data.height],u_matrix:t,u_offset:C(e)?e:0,u_color_ramp:this.colorRampTexture,u_color_range:this.colorRange,u_mapping_range:this.options.mappingRange||[0,0]};if(i&&(n.u_cameraEye=i.cameraEye,n.u_cameraEye64Low=i.cameraEye64Low),"rg"===this.options.renderForm){n.u_wind_min=[this.data.uMin,this.data.vMin],n.u_wind_max=[this.data.uMax,this.data.vMax],n.u_wind=this.data.texture;const t=[Math.sqrt(this.data.uMin*this.data.uMin+this.data.vMin*this.data.vMin),Math.sqrt(this.data.uMin*this.data.uMin+this.data.vMax*this.data.vMax),Math.sqrt(this.data.uMax*this.data.uMax+this.data.vMax*this.data.vMax),Math.sqrt(this.data.uMax*this.data.uMax+this.data.vMin*this.data.vMin)],e=0,i=Math.max(...t);n.u_display_range=this.options.displayRange||[e,i]}else"r"===this.options.renderForm?(n.u_range=[this.data.min,this.data.max],n.u_image=this.data.texture,n.u_display_range=this.options.displayRange||[n.u_range[0]-1,n.u_range[1]+1]):console.warn("This type is not supported temporarily");const s=this.gl.isEnabled(this.gl.DEPTH_TEST);this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthMask(!0),this.gl.depthFunc(this.gl.LEQUAL);const o=this.options.wireframe?this.data.wireframeIndexes:this.data.indexes;this.drawCommand.active().setUniforms(n).setAttributes({instancePositions:{buffer:this.data.quadBuffer,numComponents:3},instancePositions64Low:{buffer:this.data.quad64LowBuffer,numComponents:3},a_texCoord:{buffer:this.data.texCoordBuffer,numComponents:2}}).elements({data:new Uint32Array(o),primitive:this.options.wireframe?this.gl.LINES:this.gl.TRIANGLES,count:null==o?void 0:o.length,usage:this.gl.STATIC_DRAW}).draw(),s||this.gl.disable(this.gl.DEPTH_TEST)}}postrender(){}destroyData(){this.data}destroyed(){this.destroyData(),this.worker&&this.worker.terminate()}}const vt={renderer:"gl",doubleBuffer:!1,animation:!1,glOptions:{antialias:!0,depth:!0,stencil:!0,alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0}};class Ct extends e.renderer.CanvasLayerRenderer{checkResources(){return[]}getDrawParams(){return[]}hitDetect(){return!1}draw(){this.prepareCanvas(),this.prepareDrawContext(),this.drawWind()}_redraw(){this.prepareRender(),this.draw()}clearCanvas(){this.gl&&M(this.gl,[0,0,0,0])}createContext(){this.gl&&this.gl.canvas===this.canvas||(this.gl=Q(this.canvas,this.layer.options.glOptions))}resizeCanvas(t){if(this.canvas&&this.gl){const e=this.getMap(),i=e.getDevicePixelRatio(),r=t||e.getSize();this.canvas.height=i*r.height,this.canvas.width=i*r.width,this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}}getMatrix(){const t=this.getMap();return t.projViewMatrix}handleZoom(){this.scalarRender&&this.scalarRender.handleZoom()}drawWind(){const t=this.getMap();if(null!==this.gl){const i=this.layer,r=i.getOptions(),n=i.getData();if(!this.scalarRender&&t&&(this.scalarRender=new Ft(this.gl,{opacity:r.opacity,renderForm:r.renderForm,styleSpec:r.styleSpec,displayRange:r.displayRange,mappingRange:r.mappingRange,widthSegments:r.widthSegments,heightSegments:r.heightSegments,createPlaneBuffer:r.createPlaneBuffer,wireframe:r.wireframe,getZoom:()=>this.getMap().getZoom(),triggerRepaint:()=>{this._redraw()},injectShaderModules:{"#modules-transformZ":"\nfloat transformZ(float value, vec3 pos) {\n  return value;\n}\n    ","#modules-project":"\ngl_Position = u_matrix * vec4(pos.xy + vec2(u_offset, 0.0), pos.z + z, 1.0);\n    "}}),this.scalarRender.getMercatorCoordinate=(([i,r])=>{const n=J(t,new e.Coordinate(i,r),H(t));return[n.x,n.y]}),this.getMap().on("zoom",this.handleZoom,this),this.scalarRender.setData(n)),this.scalarRender){const t=this.getMatrix(),e=[0,0,0,1],i=e.map(t=>A(t)),r=this.getWrappedWorlds();for(let n=0;n<r.length;n++)this.scalarRender.render(t,r[n],{cameraEye:e,cameraEye64Low:i})}}this.completeRender()}getWrappedWorlds(){const t=this.getMap(),i=t.getProjection().fullExtent,r=[i.left,i.bottom,i.right,i.top],n=t.getProjExtent(),s=[n.xmin,n.ymin,n.xmax,n.ymax];let o=s[0];const a=P(r),l=Math.abs(J(t,t.getProjection().unprojectCoords(new e.Coordinate([r[0],r[1]])),H(t)).x-J(t,t.getProjection().unprojectCoords(new e.Coordinate([r[2],r[3]])),H(t)).x);let c=0;const h=[],g=this.layer,u=g.getOptions();if(u.wrapX){for(;o<r[0];)--c,h.push(c*l),o+=a;for(c=0,o=s[2];o>r[2];)++c,h.push(c*l),o-=a}return h.push(0),h}drawOnInteracting(){this.draw()}onZoomStart(...t){super.onZoomStart.apply(this,t)}onZoomEnd(...t){super.onZoomEnd.apply(this,t)}onDragRotateStart(...t){super.onDragRotateStart.apply(this,t)}onDragRotateEnd(...t){super.onDragRotateEnd.apply(this,t)}onMoveStart(...t){super.onMoveStart.apply(this,t)}onMoveEnd(...t){super.onMoveEnd.apply(this,t)}remove(){delete this._drawContext,super.remove()}getMap(){return super.getMap()}completeRender(){return super.completeRender()}prepareCanvas(){return super.prepareCanvas()}prepareDrawContext(){super.prepareDrawContext()}prepareRender(){return super.prepareRender()}}class yt extends e.CanvasLayer{constructor(t,e,i){super(t,{...vt,...i}),this.data=null,this._map=null,e&&this.setData(e)}getData(){return this.data}setData(t){return new Promise((e,i)=>{this.data=t;const r=this._getRenderer();this.data&&r&&r.scalarFill?r.scalarFill.setData(this.data,t=>{t?e(!0):i(!1)}):e(!1)})}setOptions(t){this.options={...this.options,...t||{}};const e=this._getRenderer();e&&e.scalarRender&&(e.scalarRender.updateOptions(this.options),e.setToRedraw())}getOptions(){return this.options||{}}draw(){return this._getRenderer()&&this._getRenderer()._redraw(),this}prepareToDraw(){return[]}drawOnInteracting(){this.draw()}_getRenderer(){return super._getRenderer()}}yt.registerRenderer("gl",Ct);const At={renderer:"canvas",doubleBuffer:!1,animation:!1,windOptions:{}};class bt extends e.renderer.CanvasLayerRenderer{checkResources(){return[]}getDrawParams(){return[]}hitDetect(){return!1}draw(){this.prepareCanvas(),this.prepareDrawContext(),this.drawWind()}_redraw(){this.prepareRender(),this.draw()}drawWind(){const t=this.getMap();if(this.context){const e=this.layer,i=e.getWindOptions();if(!this.wind&&t){const t=e.getData();this.wind=new st(this.context,i,t),this.wind.project=this.project.bind(this),this.wind.unproject=this.unproject.bind(this),this.wind.intersectsCoordinate=this.intersectsCoordinate.bind(this),this.wind.postrender=(()=>{this.setCanvasUpdated()}),this.wind.prerender()}this.wind&&(this.wind.prerender(),this.wind.render())}this.completeRender()}project(t){const i=this.getMap(),r=i.coordinateToContainerPoint(new e.Coordinate(t[0],t[1]));return[r.x,r.y]}unproject(t){const i=this.getMap(),r=i.containerPointToCoordinate(new e.Point(t[0],t[1]));return r.toArray()}intersectsCoordinate(t){var e;if(!this.layer)return!1;const i=null==(e=this.layer)?void 0:e.getProjection();if(i&&"EPSG:3857"!==i.code)return!0;const r=this.getMap(),n=r.getProjExtent(),s=[n.xmin,n.ymin,n.xmax,n.ymax],o=K(s,0);return N(o,[t[0],t[1]])}drawOnInteracting(){}onZoomStart(...t){this.wind&&this.wind.stop(),super.onZoomStart.apply(this,t)}onZoomEnd(...t){this.wind&&this.wind.start(),super.onZoomEnd.apply(this,t)}onDragRotateStart(...t){this.wind&&this.wind.stop(),super.onDragRotateStart.apply(this,t)}onDragRotateEnd(...t){this.wind&&this.wind.start(),super.onDragRotateEnd.apply(this,t)}onMoveStart(...t){this.wind&&this.wind.stop(),super.onMoveStart.apply(this,t)}onMoveEnd(...t){this.wind&&this.wind.start(),super.onMoveEnd.apply(this,t)}remove(){this.wind&&this.wind.stop(),delete this._drawContext,super.remove()}getMap(){return super.getMap()}prepareCanvas(){return super.prepareCanvas()}prepareDrawContext(){super.prepareDrawContext()}prepareRender(){return super.prepareRender()}completeRender(){return super.completeRender()}}class St extends e.CanvasLayer{constructor(t,e,i={}){super(t,l({},At,i)),this._map=null,this.pickWindOptions(),e&&this.setData(e,i.fieldOptions)}pickWindOptions(){Object.keys(nt).forEach(t=>{this.options&&t in this.options&&(void 0===this.options.windOptions&&(this.options.windOptions={}),this.options.windOptions[t]=this.options[t])})}getData(){return this.field}setData(t,e={}){t&&t.checkFields&&t.checkFields()?this.field=t:a(t)?this.field=d(t,e):console.error("Illegal data");const i=this._getRenderer();return i&&i.wind&&this.field&&i.wind.updateData(this.field),this}setWindOptions(t){const e=this.options.windOptions||{};this.options=l(this.options,{windOptions:l(e,t||{})});const i=this._getRenderer();if(i&&i.wind){const t=this.options.windOptions;i.wind.setOptions(t)}}getWindOptions(){return this.options.windOptions||{}}draw(){return this._getRenderer()&&this._getRenderer()._redraw(),this}prepareToDraw(){return[]}drawOnInteracting(){this.draw()}_getRenderer(){return super._getRenderer()}}St.registerRenderer("canvas",bt);const Qt=St;t.Field=rt,t.ScalarLayer=yt,t.ScalarLayerRenderer=Ct,t.WindLayer=Qt,t.WindLayerRenderer=bt,t.default=St,Object.defineProperty(t,"__esModule",{value:!0});var Et="undefined"==typeof window?global:window;Et&&Et.maptalksGfsWind&&(window.MaptalksWind=window.maptalksGfsWind,q("MaptalksWind namespace will deprecated please use maptalksGfsWind insteadÔºÅ"))});